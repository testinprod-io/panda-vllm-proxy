{"manifest_version":2,"name":"panda-prod","runner":"docker-compose","docker_compose_file":"x-common: &common-config\n  logging:\n    driver: \"json-file\"\n    options:\n      max-size: \"100m\"\n      max-file: \"5\"\n  restart: unless-stopped\n\nvolumes:\n  shared-tmpfs:\n    driver: local\n    driver_opts:\n      type: \"tmpfs\"\n      device: \"tmpfs\"\n      o: \"size=64m\"\n\nservices:\n  nginx:\n    <<: *common-config\n    image: testinprod/panda-nginx:0.0.5\n    container_name: nginx\n    ports:\n      - \"443:443\"\n    volumes:\n      - /var/run/dstack.sock:/var/run/dstack.sock\n      - shared-tmpfs:/cert-dir\n    environment:\n      - PANDA_LLM_DOMAIN=llm-alpha.panda.chat\n      - PANDA_LLM_CERT_DOMAINS=[\"llm-alpha.panda.chat\", \"nil2.panda.chat\"]\n      - PANDA_CERT_DIR=/cert-dir\n      - PANDA_ACME_URL=https://acme-v02.api.letsencrypt.org/directory\n      - PANDA_CF_API_TOKEN=${PANDA_CF_API_TOKEN}\n      - PANDA_CF_ZONE_ID=${PANDA_CF_ZONE_ID}\n      - PANDA_APP_SERVER=https://app.panda.chat\n      - PANDA_APP_SERVER_TOKEN=${PANDA_APP_SERVER_TOKEN}\n\n  vllm-proxy-deepseek:\n    <<: *common-config\n    image: testinprod/panda-vllm-proxy:0.0.3\n    container_name: vllm-proxy-deepseek\n    privileged: true\n    ports:\n      - \"8000:8000\"\n    volumes:\n      - shared-tmpfs:/cert-dir\n    environment:\n      JWT_PUB_KEY: |\n        -----BEGIN PUBLIC KEY-----\n        MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE/VjJFvojh5S98Bf7F8pai1cwYCWUqh4D3W8yP5cKMVU6LM1XnQDdnmiqZg3H71z4y/sZohkJR5utIEASSqXZpg==\n        -----END PUBLIC KEY-----\n      WORKERS: 4\n      VLLM_URL: http://vllm-deepseek:8000/v1/chat/completions\n      VLLM_MODEL_URL: http://vllm-deepseek:8000/v1/models\n      SUMMARIZATION_VLLM_URL: http://vllm-llama:8000/v1/chat/completions\n      MODEL_NAME: ig1/r1-1776-AWQ\n      SUMMARIZATION_MODEL: RedHatAI/Llama-4-Scout-17B-16E-Instruct-quantized.w4a16\n      MAX_MODEL_LENGTH: 65536\n      JWT_ALGORITHM: ES256\n      APP_ID: cmavhlsn7019ll20lsdkqf0so\n      BRAVE_SEARCH_API_KEY: ${BRAVE_SEARCH_API_KEY}\n      MILVUS_URI: http://standalone:19530\n      CORS_ALLOWED_ORIGINS: \"[\\\"*\\\"]\"\n      TLS_CERT_PATH: /cert-dir/live/cert.pem\n      TLS_CERT_PRIVATE_KEY_PATH: /cert-dir/live/key.pem\n      HF_HOME: /tmp/huggingface/deepseek\n    depends_on:\n      - vllm-deepseek\n\n  vllm-proxy-llama:\n    <<: *common-config\n    image: testinprod/panda-vllm-proxy:0.0.3\n    container_name: vllm-proxy-llama\n    privileged: true\n    ports:\n      - \"8001:8000\"\n    volumes:\n      - shared-tmpfs:/cert-dir\n    environment:\n      JWT_PUB_KEY: |\n        -----BEGIN PUBLIC KEY-----\n        MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE/VjJFvojh5S98Bf7F8pai1cwYCWUqh4D3W8yP5cKMVU6LM1XnQDdnmiqZg3H71z4y/sZohkJR5utIEASSqXZpg==\n        -----END PUBLIC KEY-----\n      WORKERS: 4\n      VLLM_URL: http://vllm-llama:8000/v1/chat/completions\n      VLLM_MODEL_URL: http://vllm-llama:8000/v1/models\n      SUMMARIZATION_VLLM_URL: http://vllm-llama:8000/v1/chat/completions\n      MODEL_NAME: RedHatAI/Llama-4-Scout-17B-16E-Instruct-quantized.w4a16\n      SUMMARIZATION_MODEL: RedHatAI/Llama-4-Scout-17B-16E-Instruct-quantized.w4a16\n      JWT_ALGORITHM: ES256\n      APP_ID: cmavhlsn7019ll20lsdkqf0so\n      BRAVE_SEARCH_API_KEY: ${BRAVE_SEARCH_API_KEY}\n      MILVUS_URI: http://standalone:19530\n      CORS_ALLOWED_ORIGINS: \"[\\\"*\\\"]\"\n      TLS_CERT_PATH: /cert-dir/live/cert.pem\n      TLS_CERT_PRIVATE_KEY_PATH: /cert-dir/live/key.pem\n      HF_HOME: /tmp/huggingface/llama\n    depends_on:\n      - vllm-llama\n\n  vllm-deepseek:\n    <<: *common-config\n    image: testinprod/panda-vllm-ray:0.9.1\n    container_name: vllm-deepseek\n    runtime: nvidia\n    ports:\n      - \"8002:8000\"\n    deploy:\n      resources:\n        reservations:\n          devices:\n            - driver: nvidia\n              capabilities: [ gpu ]\n              device_ids: [ \"0\",\"1\",\"2\",\"3\",\"4\",\"5\" ]\n    volumes:\n      - /var/volatile/dstack/persistent:/data\n    shm_size: \"32g\"\n    entrypoint: [\"/bin/sh\", \"-c\", \"sleep 60 && exec python3 -m vllm.entrypoints.openai.api_server \\\"$@\\\"\", \"--\"]\n    command: >\n      --model ig1/r1-1776-AWQ\n      --dtype auto\n      --tensor-parallel-size 2\n      --pipeline-parallel-size 3\n      --gpu-memory-utilization 0.95\n      --enable-chunked-prefill\n      --enable-reasoning  \n      --reasoning-parser deepseek_r1  \n      --max-model-len 65536\n      --download-dir /data/vllm-deepseek\n      --distributed-executor-backend ray\n      --disable-log-requests\n    environment:\n      - OMP_NUM_THREADS=16\n      - LLM_USE_V1=1\n      - HF_TOKEN=${HF_TOKEN}\n      - CUDA_DEVICE_ORDER=PCI_BUS_ID\n\n  vllm-llama:\n    <<: *common-config\n    image: testinprod/panda-vllm-ray:0.9.1\n    container_name: vllm-llama\n    runtime: nvidia\n    ports:\n      - \"8003:8000\"\n    volumes:\n      - /var/volatile/dstack/persistent:/data\n    shm_size: \"32g\"\n    deploy:\n      resources:\n        reservations:\n          devices:\n            - driver: nvidia\n              capabilities: [ gpu ]\n              device_ids: [ \"6\", \"7\" ]\n    entrypoint: [\"/bin/sh\", \"-c\", \"sleep 60 && exec python3 -m vllm.entrypoints.openai.api_server \\\"$@\\\"\", \"--\"]\n    command: >\n      --model RedHatAI/Llama-4-Scout-17B-16E-Instruct-quantized.w4a16\n      --dtype auto\n      --max-model-len 100000\n      --tensor-parallel-size 2\n      --gpu-memory-utilization 0.95\n      --download-dir /data/vllm-llama\n      --distributed-executor-backend ray\n      --disable-log-requests\n    environment:\n      - OMP_NUM_THREADS=16\n      - LLM_USE_V1=1\n      - HF_TOKEN=${HF_TOKEN}\n      - CUDA_DEVICE_ORDER=PCI_BUS_ID\n\n  etcd:\n    <<: *common-config\n    container_name: milvus-etcd\n    image: quay.io/coreos/etcd:v3.5.18\n    environment:\n      - ETCD_AUTO_COMPACTION_MODE=revision\n      - ETCD_AUTO_COMPACTION_RETENTION=1000\n      - ETCD_QUOTA_BACKEND_BYTES=4294967296\n      - ETCD_SNAPSHOT_COUNT=50000\n    volumes:\n      - /var/volatile/dstack/persistent:/data\n    command: etcd -advertise-client-urls=http://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /data/etcd\n    healthcheck:\n      test: [\"CMD\", \"etcdctl\", \"endpoint\", \"health\"]\n      interval: 30s\n      timeout: 20s\n      retries: 3\n\n  minio:\n    <<: *common-config\n    container_name: milvus-minio\n    image: minio/minio:RELEASE.2023-03-20T20-16-18Z\n    environment:\n      MINIO_ACCESS_KEY: minioadmin\n      MINIO_SECRET_KEY: minioadmin\n    ports:\n      - \"9001:9001\"\n      - \"9000:9000\"\n    volumes:\n      - /var/volatile/dstack/persistent:/data\n    command: minio server /data/minio --console-address \":9001\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:9000/minio/health/live\"]\n      interval: 30s\n      timeout: 20s\n      retries: 3\n\n  standalone:\n    <<: *common-config\n    container_name: milvus-standalone\n    image: milvusdb/milvus:v2.5.12\n    command: [\"milvus\", \"run\", \"standalone\"]\n    security_opt:\n    - seccomp:unconfined\n    environment:\n      MINIO_REGION: us-east-1\n      ETCD_ENDPOINTS: etcd:2379\n      MINIO_ADDRESS: minio:9000\n    volumes:\n      - /var/volatile/dstack/persistent:/var/lib/milvus\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:9091/healthz\"]\n      interval: 30s\n      start_period: 90s\n      timeout: 20s\n      retries: 3\n    ports:\n      - \"19530:19530\"\n      - \"9091:9091\"\n    depends_on:\n      - \"etcd\"\n      - \"minio\"\n\n  alloy:\n    <<: *common-config\n    image: testinprod/panda-alloy:0.0.1\n    environment:\n      - PROMETHEUS_HOST=${PROMETHEUS_HOST}\n      - LOKI_HOST=${LOKI_HOST}\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    ports: [\"12345:12345\"]\n","docker_config":{},"kms_enabled":true,"gateway_enabled":true,"public_logs":true,"public_sysinfo":true,"public_tcbinfo":true,"local_key_provider_enabled":false,"key_provider_id":"","allowed_envs":["PANDA_CF_API_TOKEN","PANDA_CF_ZONE_ID","PANDA_APP_SERVER_TOKEN","BRAVE_SEARCH_API_KEY","HF_TOKEN","PROMETHEUS_HOST","LOKI_HOST"],"no_instance_id":false,"secure_time":false,"pre_launch_script":""}